<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.0 -->
<title>MineCraft PE in IBM BlueMix K8s | Chris Phillips’ Blog</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="MineCraft PE in IBM BlueMix K8s" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="MineCraft PE in IBM BlueMix K8s" />
<meta property="og:description" content="MineCraft PE in IBM BlueMix K8s" />
<link rel="canonical" href="/apiconnect/2017/08/04/MineCraft-PE-in-IBM-BlueMix-K8s.html" />
<meta property="og:url" content="/apiconnect/2017/08/04/MineCraft-PE-in-IBM-BlueMix-K8s.html" />
<meta property="og:site_name" content="Chris Phillips’ Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-08-04T01:00:00+01:00" />
<script type="application/ld+json">
{"description":"MineCraft PE in IBM BlueMix K8s","@type":"BlogPosting","url":"/apiconnect/2017/08/04/MineCraft-PE-in-IBM-BlueMix-K8s.html","headline":"MineCraft PE in IBM BlueMix K8s","dateModified":"2017-08-04T01:00:00+01:00","datePublished":"2017-08-04T01:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"/apiconnect/2017/08/04/MineCraft-PE-in-IBM-BlueMix-K8s.html"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Chris Phillips' Blog" /><!---->
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Chris Phillips&#39; Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">MineCraft PE in IBM BlueMix K8s</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-08-04T01:00:00+01:00" itemprop="datePublished">Aug 4, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="minecraft-pe-in-ibm-bluemix-k8s">MineCraft PE in IBM BlueMix K8s</h1>

<p>Like many parents our there I think my daughters are addicted to
MineCraft Pocket Edition. Though we have had a lot of fun building
stuff…</p>

<hr />

<h3 id="minecraft-pe-in-ibm-bluemixk8s">MineCraft PE in IBM BlueMix K8s</h3>

<p>Like many parents our there I think my daughters are addicted to
MineCraft Pocket Edition. Though we have had a lot of fun building stuff
together.</p>

<p>Recently I looked at trying to run my own server so I can play with them
when I am away for work.</p>

<p>As a Developer I have access to a free BlueMix account and decided this
would be a great time to learn the new HA Autoscaling Docker container
system that is K8s. (Sign up her <a href="https://console.bluemix.net">https://console.bluemix.net</a>)</p>

<p>Bear in mind this article wont talk about scaling as the the MineCraft
container you will build will not be stateless. I hope to take a look at
making it <em>more</em> stateless in the future.</p>

<p>The first thing we need is the server code. I used the Nukkit 3rd party
server. <a href="https://github.com/Nukkit/Nukkit">https://github.com/Nukkit/Nukkit</a></p>

<p><strong>Clone and Compiling</strong></p>

<p>Please Note I had to modify the source to make it work. I am sure people
more knowledgeable of the code will tell my why this change is not
needed.</p>

<p>Firstly I checked out the code</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/Nukkit/Nukkit.git
</code></pre></div></div>

<p>I changed one variable in
<a href="https://github.com/Nukkit/Nukkit/blob/master/src/main/java/cn/nukkit/raknet/server/SessionManager.java">src/main/java/cn/nukkit/raknet/server/SessionManager.java</a> on line 45</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public boolean portChecking = true;
</code></pre></div></div>

<p>to</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public boolean portChecking = false;
</code></pre></div></div>

<p>The issue I hit was that the UDP Packets did not have the server port
correctly specified and so it was not starting a session. (I never want
to have to stare at a UDP dump again if i can avoid it)</p>

<p>Now we need to build the code. go to the root directory of the checked
out code and run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mvn install
</code></pre></div></div>

<p>I am assuming you have the maven build tools installed and a JDK.</p>

<p>Congrats you now have a jar file in the target directory.</p>

<p><strong>Dockerization</strong></p>

<p>I then created a docker directory to contain the DockerFile and other
important files.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir docker
</code></pre></div></div>

<p>When you first start the jar file it asks you some initial configuration
questions, this is not what we want as we want a non interactive start
and so we must precreate the configuration. The easiest way to do this
is to run the server code locally and it will then create the files
required.</p>

<p>First i recommend you copy the jar file to the docker directory</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cp -rf target/nukkit-1.0-SNAPSHOT.jar docker
</code></pre></div></div>

<p>then to start the server</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd docker
java -jar -Dfile.encoding=UTF8 nukkit-1.0-SNAPSHOT.jar nogui
</code></pre></div></div>

<p>Answer the initial questions then quit the server. You will see that a
server.properties and a nukkit.yml (amongst others) has been created.</p>

<p>We then need to create the DockerFile.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu:latest
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RUN apt-get purge openjdk* &amp;&amp;  apt-get autoremove
RUN apt-key adv --keyserver keys.gnupg.net --recv-keys 5CB26B26 &amp;&amp; echo "deb http://www.duinsoft.nl/pkg debs all" |  tee -a /etc/apt/sources.list.d/duinsoft.list &amp;&amp; apt-get update
RUN apt-get install -y software-properties-common lsof
RUN add-apt-repository ppa:webupd8team/java &amp;&amp; apt-get update
RUN echo "oracle-java8-installer shared/accepted-oracle-license-v1-1 select true" | debconf-set-selections
RUN echo "oracle-java8-installer shared/accepted-oracle-license-v1-1 seen true" | debconf-set-selections
RUN apt-get install -y oracle-java8-installer
RUN apt-get clean
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>RUN mkdir nukkit
COPY nukkit-1.0-SNAPSHOT.jar /nukkit
COPY server.properties /nukkit
COPY nukkit.yml /nukkit
COPY run.sh /nukkit
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>EXPOSE 8080
CMD sh /nukkit/run.sh
</code></pre></div></div>

<p>I prefer to start scripts from a shell script rather then directly from
the DockerFile so I created a run.sh</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/bash</span>
<span class="nb">cd</span> /nukkit <span class="o">&amp;&amp;</span> java <span class="nt">-jar</span> <span class="nt">-Djava</span>.net.preferIPv4Stack<span class="o">=</span><span class="nb">true</span> <span class="nt">-Dfile</span>.encoding<span class="o">=</span>UTF8 nukkit-1.0-SNAPSHOT.jar nogui
</code></pre></div></div>

<p>In the future if i need to enable additional debugging this run script
can easily be extended.</p>

<p>I am using the UK BlueMix server and so i set the docker tag to the
following</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker -t registry.eu-gb.bluemix.net/cminion/minecraft:0.01 .
</code></pre></div></div>

<p><strong>Logging into BlueMix</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bx login
</code></pre></div></div>

<p>or if you are an IBMer</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bx login --sso
</code></pre></div></div>

<p><strong>Creating the Container Registry Namespace</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bx cr --namespace-add &lt;NAMESPACE&gt;
</code></pre></div></div>

<p>In my examples i use the namespace cminion.</p>

<p><strong>Pushing the image to the Container Registry</strong></p>

<p>Now we can push the image to BlueMix</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker push
</code></pre></div></div>

<p>When this is complete we can validate it is there with</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chris$ bx cr images
Listing images...

REPOSITORY                                     NAMESPACE   TAG    DIGEST         CREATED        SIZE     VULNERABILITY STATUS    
registry.eu-gb.bluemix.net/cminion/minecraft   cminion     9      926b984a0062   14 hours ago   517 MB   OK   

OK
</code></pre></div></div>

<p><strong>Deploying to Kubernetes</strong></p>

<p>I am going to assume that you already have a Kubernates cluster
deployed. Mine is called myCluster.</p>

<p>Ensure that you the KUBECONFIG variable configured in your environment.</p>

<p>Mine is like below but this will depending on how you configured your
cluster .</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>export KUBECONFIG=/Users/chris/.bluemix/plugins/container-service/clusters/mycluster/kube-config-par01-mycluster.yml
</code></pre></div></div>

<p>Create a deployment.yml as below</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: "1"
  generation: 1
  labels:
    run: mcnew
  name: mcnew
  namespace: default
  selfLink: /apis/extensions/v1beta1/namespaces/default/deployments/mcnew
spec:
  replicas: 1
  selector:
    matchLabels:
      run: mcnew
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        run: mcnew
    spec:
      containers:
      - image: registry.eu-gb.bluemix.net/cminion/minecraft:9
        imagePullPolicy: IfNotPresent
        name: mcnew
        ports:
        - containerPort: 19132
          protocol: UDP
        resources:
        terminationMessagePath: /dev/termination-log
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      securityContext:
      terminationGracePeriodSeconds: 30
status:
  availableReplicas: 1
  conditions:
  - lastTransitionTime: 2017-08-03T17:50:22Z
    lastUpdateTime: 2017-08-03T17:50:22Z
    message: Deployment has minimum availability.
    reason: MinimumReplicasAvailable
    status: "True"
    type: Available
  observedGeneration: 1
  replicas: 1
  updatedReplicas: 1
</code></pre></div></div>

<p>They key things to ensure are correct are</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- containerPort: 19132
  protocol: UDP
</code></pre></div></div>

<p>This is the port the server is configured to run on and it MUST use
UDP. ,</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- image: registry.eu-gb.bluemix.net/cminion/minecraft:9
</code></pre></div></div>

<p>This should be the path to your image in the registry.</p>

<p>Once the file is saved you can run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f  deployment.yml
</code></pre></div></div>

<p>then the following to validate is there.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chris$ kubectl get deployment mcnew
NAME DESIRED CURRENT UP-TO-DATE AVAILABLE AGE
mcnew    1     1       1         1        14h
</code></pre></div></div>

<p>Now we must expose the container. To do this we create a service.yml.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apiVersion: v1
kind: Service
metadata:
  labels:
    run: mcnew
  name: mcnew
  namespace: default
  selfLink: /api/v1/namespaces/default/services/mcnew
spec:
  clusterIP: 10.10.10.39
  ports:
  - nodePort: 31259
    port: 19132
    protocol: UDP
    targetPort: 19132
  selector:
    run: mcnew
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer:
</code></pre></div></div>

<p>Again please note the protocol must be UDP and the port and target port
should be the port MineCraft is running on. The NodePort is the port you
will use to connect to your server.</p>

<p>Run the following command to create the service.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl create -f service.yml
</code></pre></div></div>

<p>The following command will validate the service is running</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chris$ kubectl get service mcnew
NAME CLUSTER-IP EXTERNAL-IP PORT(S) AGE
mcnew 10.10.10.39 &lt;nodes&gt; 19132:31259/UDP 15h
</code></pre></div></div>

<p>In order to get the IP address this is available on you must run</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>chris$ kubectl get nodes
NAME         STATUS    AGE
169.51.8.1   Ready     10d
</code></pre></div></div>

<p>Then you load up MineCraft PE on your mobile or console and connect to
169.51.8.1 on port 31259.</p>

<p><img src="https://cdn-images-1.medium.com/max/1200/1*ZEV-7ItE867dI-4AkWGknQ.jpeg" alt="" /></p>

<p>This tutorial has shown a very simple way to get a single container
running in k8s. This does not make us of the HA or scaling function yet.</p>

<p>By <a href="https://medium.com/@cminion">Chris Phillips</a> on
<a href="https://medium.com/p/d42433fd0473">August 4, 2017</a>.</p>

<p><a href="https://medium.com/@cminion/minecraft-pe-in-ibm-bluemix-k8s-d42433fd0473">Canonical
link</a></p>

<p>Exported from <a href="https://medium.com">Medium</a> on April 6, 2019.</p>

  </div><a class="u-url" href="/apiconnect/2017/08/04/MineCraft-PE-in-IBM-BlueMix-K8s.html" hidden></a>
</article>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog1 -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5762182881741486"
     data-ad-slot="5834821709"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col one-half">
      <h2 class="footer-heading">Chris Phillips&#39; Blog</h2>
        <ul class="contact-list">
          <li class="p-name">Chris Phillips&#39; Blog</li><li><a class="u-email" href="mailto:chris.phillips@uk.ibm.com">chris.phillips@uk.ibm.com</a></li></ul>
      </div>

      <div class="footer-col one-half">
        <p>Father of 2 - IBM Master Inventor &amp; SWAT Integration Architect - API, Integration and Governance SME and Enthusiast, Board Gamer, My opinions are very much mine</p>
      </div>

      <div class="social-links"><ul class="social-media-list"></ul>
</div>
    </div>

  </div>

</footer>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-139881144-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-139881144-1');
</script>


  </body>

</html>
